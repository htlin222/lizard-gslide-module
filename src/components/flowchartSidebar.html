<!doctype html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 16px;
        font-size: 14px;
        background-color: #f8f9fa;
      }

      .section {
        background: white;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .section-title {
        font-weight: bold;
        font-size: 16px;
        margin-bottom: 12px;
        color: #1a73e8;
        border-bottom: 1px solid #e8f0fe;
        padding-bottom: 8px;
      }

      .form-group {
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      label {
        font-weight: 500;
        flex: 1;
        margin-right: 10px;
        color: #333;
      }

      input[type="number"] {
        width: 60px;
        padding: 6px 8px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        text-align: center;
        font-size: 14px;
      }

      input[type="number"]:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
      }

      button {
        width: 100%;
        padding: 6px 6px;
        background-color: #1a73e8;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 8px;
        transition: background-color 0.2s;
      }

      button:hover {
        background-color: #1557b0;
      }

      button:active {
        background-color: #0d47a1;
      }

      button.secondary {
        background-color: #34a853;
      }

      button.secondary:hover {
        background-color: #2d8f47;
      }

      button.tertiary {
        background-color: #ea4335;
      }

      button.tertiary:hover {
        background-color: #d33b2c;
      }

      .input-suffix {
        font-size: 12px;
        color: #666;
        margin-left: 5px;
      }

      .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
        line-height: 1.4;
      }

      .gap-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .gap-controls input {
        width: 50px;
      }

      .button-group {
        display: flex;
        gap: 4px;
      }

      .button-group button {
        flex: 1;
        margin-bottom: 0;
      }

      .graph-id-display {
        background-color: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 12px;
        margin-top: 12px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-all;
        min-height: 60px;
        max-height: 150px;
        overflow-y: auto;
      }

      .graph-id-display.empty {
        color: #999;
        font-style: italic;
        font-family: Arial, sans-serif;
      }

      .tab-container {
        display: flex;
        margin-bottom: 12px;
        border-bottom: 1px solid #e0e0e0;
      }

      .tab-button {
        flex: 1;
        padding: 8px 12px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        color: #666;
        margin-bottom: 0;
        transition: all 0.2s;
      }

      .tab-button.active {
        color: #1a73e8;
        border-bottom-color: #1a73e8;
        background-color: #f8f9fa;
      }

      .tab-button:hover {
        background-color: #f5f5f5;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .text-input-area {
        width: 100%;
        min-height: 80px;
        max-height: 120px;
        padding: 8px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 12px;
        font-family: Arial, sans-serif;
        resize: vertical;
        line-height: 1.4;
      }

      .text-input-area:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
      }

      .line-count-info {
        font-size: 11px;
        color: #666;
        margin-top: 4px;
        text-align: right;
      }

      details {
        background: white;
        border-radius: 8px;
        padding: 0;
        margin-bottom: 16px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      summary {
        font-weight: bold;
        font-size: 16px;
        color: #1a73e8;
        border-bottom: 1px solid #e8f0fe;
        padding: 16px;
        cursor: pointer;
        user-select: none;
        list-style: none;
      }

      summary::-webkit-details-marker {
        display: none;
      }

      summary::before {
        content: "‚ñ∂";
        margin-right: 8px;
        transition: transform 0.2s;
      }

      details[open] summary::before {
        transform: rotate(90deg);
      }

      summary:hover {
        background-color: #f8f9fa;
      }

      .details-content {
        padding: 16px;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes slideDown {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(100%);
          opacity: 0;
        }
      }
    </style>
  </head>
  <body>
    <details>
      <summary>‚öôÔ∏è Line Settings</summary>
      <div class="details-content">
        <div class="form-group">
          <label for="lineType">Line Type:</label>
          <select
            id="lineType"
            style="
              width: 120px;
              padding: 6px 8px;
              border: 1px solid #dadce0;
              border-radius: 4px;
              font-size: 14px;
            "
          >
            <option value="STRAIGHT" selected>Straight</option>
            <option value="BENT">Bent/Elbow</option>
            <option value="CURVED">Curved</option>
          </select>
        </div>

        <div class="form-group">
          <label for="startArrow">Start Arrow:</label>
          <select
            id="startArrow"
            style="
              width: 120px;
              padding: 6px 8px;
              border: 1px solid #dadce0;
              border-radius: 4px;
              font-size: 14px;
            "
          >
            <option value="NONE" selected>None</option>
            <option value="FILL_ARROW">Fill Arrow</option>
            <option value="STEALTH_ARROW">Stealth Arrow</option>
            <option value="OPEN_ARROW">Open Arrow</option>
            <option value="FILL_CIRCLE">Fill Circle</option>
            <option value="OPEN_CIRCLE">Open Circle</option>
            <option value="FILL_SQUARE">Fill Square</option>
            <option value="OPEN_SQUARE">Open Square</option>
            <option value="FILL_DIAMOND">Fill Diamond</option>
            <option value="OPEN_DIAMOND">Open Diamond</option>
          </select>
        </div>

        <div class="form-group">
          <label for="endArrow">End Arrow:</label>
          <select
            id="endArrow"
            style="
              width: 120px;
              padding: 6px 8px;
              border: 1px solid #dadce0;
              border-radius: 4px;
              font-size: 14px;
            "
          >
            <option value="NONE">None</option>
            <option value="FILL_ARROW" selected>Fill Arrow</option>
            <option value="STEALTH_ARROW">Stealth Arrow</option>
            <option value="OPEN_ARROW">Open Arrow</option>
            <option value="FILL_CIRCLE">Fill Circle</option>
            <option value="OPEN_CIRCLE">Open Circle</option>
            <option value="FILL_SQUARE">Fill Square</option>
            <option value="OPEN_SQUARE">Open Square</option>
            <option value="FILL_DIAMOND">Fill Diamond</option>
            <option value="OPEN_DIAMOND">Open Diamond</option>
          </select>
        </div>
      </div>
    </details>

    <div class="section">
      <div class="section-title">üîó Connect Shapes</div>
      <br />
      <div class="button-group">
        <button onclick="connectShapesVertical()">‚¨Ü‚¨á Connect Top/Down</button>
        <button onclick="connectShapesHorizontal()">
          ‚¨Ö‚û° Connect Left/Right
        </button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">‚ûï Create Child Shapes</div>

      <div class="tab-container">
        <button class="tab-button active" onclick="switchTab('count')">
          üìä By Count
        </button>
        <button class="tab-button" onclick="switchTab('text')">
          üìù By Text
        </button>
      </div>

      <!-- Count Tab -->
      <div id="countTab" class="tab-content active">
        <div class="form-group">
          <label for="childrenCount">Children Count:</label>
          <div class="gap-controls">
            <input
              type="number"
              id="childrenCount"
              min="1"
              max="10"
              value="1"
            />
            <span class="input-suffix">shapes</span>
          </div>
        </div>
      </div>

      <!-- Text Tab -->
      <div id="textTab" class="tab-content">
        <div
          class="form-group"
          style="flex-direction: column; align-items: stretch"
        >
          <label for="childrenText" style="margin-bottom: 6px"
            >Children Text (one per line):</label
          >
          <textarea
            id="childrenText"
            class="text-input-area"
            placeholder="Enter text for each child shape...&#10;Line 1 = Child 1&#10;Line 2 = Child 2&#10;Line 3 = Child 3"
            oninput="updateLineCount()"
          ></textarea>
          <div id="lineCount" class="line-count-info">0 lines ‚Üí 0 children</div>
        </div>
      </div>

      <div class="form-group">
        <label for="horizontalGap">Horizontal Gap:</label>
        <div class="gap-controls">
          <input type="number" id="horizontalGap" min="0" value="20" />
          <span class="input-suffix">pt</span>
        </div>
      </div>

      <div class="form-group">
        <label for="verticalGap">Vertical Gap:</label>
        <div class="gap-controls">
          <input type="number" id="verticalGap" min="0" value="20" />
          <span class="input-suffix">pt</span>
        </div>
      </div>

      <br />

      <div class="button-group">
        <button class="secondary" onclick="createChildTop()">
          ‚¨Ü Create Top
        </button>
        <button class="tertiary" onclick="createChildRight()">
          ‚û° Create Right
        </button>
      </div>
      <div class="button-group" style="margin-top: 8px">
        <button class="secondary" onclick="createChildBottom()">
          ‚¨á Create Bottom
        </button>
        <button class="tertiary" onclick="createChildLeft()">
          ‚¨Ö Create Left
        </button>
      </div>

      <br />
      <button
        class="secondary"
        onclick="createSibling()"
        style="width: 100%; background-color: #ff9800"
      >
        üë• Create Sibling
      </button>
    </div>

    <div class="section">
      <div class="section-title">üîß Graph ID Inspector</div>
      <div class="button-group">
        <button onclick="showGraphId()" style="background-color: #2196f3">
          üëÅÔ∏è Refresh
        </button>
        <button
          class="tertiary"
          onclick="clearGraphId()"
          style="background-color: #f44336"
        >
          üóëÔ∏è Clear
        </button>
      </div>
      <div id="graphIdDisplay" class="graph-id-display empty">
        Select a shape and click Refresh to view its Graph ID
      </div>
    </div>

    <script>
      function connectShapesVertical() {
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        google.script.run
          .withSuccessHandler(function () {
            showMessage("Shapes connected vertically!");
          })
          .withFailureHandler(function (error) {
            showMessage("Error: " + error, true);
          })
          .connectSelectedShapesVertical(lineType, startArrow, endArrow);
      }

      function connectShapesHorizontal() {
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        google.script.run
          .withSuccessHandler(function () {
            showMessage("Shapes connected horizontally!");
          })
          .withFailureHandler(function (error) {
            showMessage("Error: " + error, true);
          })
          .connectSelectedShapesHorizontal(lineType, startArrow, endArrow);
      }

      function createChildTop() {
        const verticalGap = parseInt(
          document.getElementById("verticalGap").value,
        );
        const childrenCount = getChildCount();
        const childrenTexts = getChildrenTextArray();
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        if (verticalGap < 0 || isNaN(verticalGap)) {
          showMessage(
            "Please enter a valid vertical gap value (0 or greater)",
            true,
          );
          return;
        }

        if (childrenCount < 1 || childrenCount > 10 || isNaN(childrenCount)) {
          showMessage("Please enter a valid children count (1-10)", true);
          return;
        }

        google.script.run
          .withSuccessHandler(function () {
            const msg =
              childrenCount === 1
                ? "Child shape created above successfully!"
                : `${childrenCount} child shapes created above successfully!`;
            showMessage(msg);
          })
          .withFailureHandler(function (error) {
            showMessage("Error: " + error, true);
          })
          .createChildTopWithText(
            verticalGap,
            lineType,
            childrenCount,
            startArrow,
            endArrow,
            childrenTexts,
          );
      }

      function createChildRight() {
        const horizontalGap = parseInt(
          document.getElementById("horizontalGap").value,
        );
        const childrenCount = getChildCount();
        const childrenTexts = getChildrenTextArray();
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        if (horizontalGap < 0 || isNaN(horizontalGap)) {
          showMessage(
            "Please enter a valid horizontal gap value (0 or greater)",
            true,
          );
          return;
        }

        if (childrenCount < 1 || childrenCount > 10 || isNaN(childrenCount)) {
          showMessage("Please enter a valid children count (1-10)", true);
          return;
        }

        google.script.run
          .withSuccessHandler(function () {
            const msg =
              childrenCount === 1
                ? "Child shape created to the right successfully!"
                : `${childrenCount} child shapes created to the right successfully!`;
            showMessage(msg);
          })
          .withFailureHandler(function (error) {
            showMessage("Error: " + error, true);
          })
          .createChildRightWithText(
            horizontalGap,
            lineType,
            childrenCount,
            startArrow,
            endArrow,
            childrenTexts,
          );
      }

      function createChildBottom() {
        const verticalGap = parseInt(
          document.getElementById("verticalGap").value,
        );
        const childrenCount = getChildCount();
        const childrenTexts = getChildrenTextArray();
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        if (verticalGap < 0 || isNaN(verticalGap)) {
          showMessage(
            "Please enter a valid vertical gap value (0 or greater)",
            true,
          );
          return;
        }

        if (childrenCount < 1 || childrenCount > 10 || isNaN(childrenCount)) {
          showMessage("Please enter a valid children count (1-10)", true);
          return;
        }

        google.script.run
          .withSuccessHandler(function () {
            const msg =
              childrenCount === 1
                ? "Child shape created below successfully!"
                : `${childrenCount} child shapes created below successfully!`;
            showMessage(msg);
          })
          .withFailureHandler(function (error) {
            showMessage("Error: " + error, true);
          })
          .createChildBottomWithText(
            verticalGap,
            lineType,
            childrenCount,
            startArrow,
            endArrow,
            childrenTexts,
          );
      }

      function createChildLeft() {
        const horizontalGap = parseInt(
          document.getElementById("horizontalGap").value,
        );
        const childrenCount = getChildCount();
        const childrenTexts = getChildrenTextArray();
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        if (horizontalGap < 0 || isNaN(horizontalGap)) {
          showMessage(
            "Please enter a valid horizontal gap value (0 or greater)",
            true,
          );
          return;
        }

        if (childrenCount < 1 || childrenCount > 10 || isNaN(childrenCount)) {
          showMessage("Please enter a valid children count (1-10)", true);
          return;
        }

        google.script.run
          .withSuccessHandler(function () {
            const msg =
              childrenCount === 1
                ? "Child shape created to the left successfully!"
                : `${childrenCount} child shapes created to the left successfully!`;
            showMessage(msg);
          })
          .withFailureHandler(function (error) {
            showMessage("Error: " + error, true);
          })
          .createChildLeftWithText(
            horizontalGap,
            lineType,
            childrenCount,
            startArrow,
            endArrow,
            childrenTexts,
          );
      }

      function createSibling() {
        const horizontalGap = parseInt(
          document.getElementById("horizontalGap").value,
        );
        const verticalGap = parseInt(
          document.getElementById("verticalGap").value,
        );
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        if (horizontalGap < 0 || isNaN(horizontalGap)) {
          showMessage(
            "Please enter a valid horizontal gap value (0 or greater)",
            true,
          );
          return;
        }

        if (verticalGap < 0 || isNaN(verticalGap)) {
          showMessage(
            "Please enter a valid vertical gap value (0 or greater)",
            true,
          );
          return;
        }

        google.script.run
          .withSuccessHandler(function () {
            showMessage("Sibling shape created successfully!");
          })
          .withFailureHandler(function (error) {
            showMessage("Error: " + error, true);
          })
          .createSiblingShape(
            horizontalGap,
            verticalGap,
            lineType,
            startArrow,
            endArrow,
          );
      }

      function showGraphId() {
        google.script.run
          .withSuccessHandler(function (result) {
            const display = document.getElementById("graphIdDisplay");
            if (
              result.includes("No Graph ID") ||
              result.includes("Please select")
            ) {
              display.className = "graph-id-display empty";
              display.textContent = result;
            } else {
              display.className = "graph-id-display";
              display.textContent = result;
            }
            // Also show a brief success message
            if (
              !result.includes("Error") &&
              !result.includes("Please select")
            ) {
              showMessage("Graph ID refreshed!");
            }
          })
          .withFailureHandler(function (error) {
            const display = document.getElementById("graphIdDisplay");
            display.className = "graph-id-display empty";
            display.textContent = "Error: " + error;
            showMessage("Error: " + error, true);
          })
          .showSelectedShapeGraphId();
      }

      function clearGraphId() {
        // Confirm before clearing
        if (
          confirm(
            "Are you sure you want to clear the Graph ID from the selected shape?",
          )
        ) {
          google.script.run
            .withSuccessHandler(function (result) {
              showMessage(result);
              // Update the display
              const display = document.getElementById("graphIdDisplay");
              display.className = "graph-id-display empty";
              if (result.includes("successfully")) {
                display.textContent =
                  "Graph ID cleared. Select another shape and click Refresh.";
              } else {
                display.textContent = result;
              }
            })
            .withFailureHandler(function (error) {
              showMessage("Error: " + error, true);
            })
            .clearSelectedShapeGraphId();
        }
      }

      // Tab switching functionality
      function switchTab(tabName) {
        // Remove active class from all tab buttons
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Remove active class from all tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        // Add active class to clicked tab button
        event.target.classList.add("active");

        // Show corresponding tab content
        if (tabName === "count") {
          document.getElementById("countTab").classList.add("active");
        } else if (tabName === "text") {
          document.getElementById("textTab").classList.add("active");
        }
      }

      // Update line count for text input
      function updateLineCount() {
        const textArea = document.getElementById("childrenText");
        const lines = textArea.value
          .split("\n")
          .filter((line) => line.trim() !== "");
        const lineCountDisplay = document.getElementById("lineCount");
        lineCountDisplay.textContent = `${lines.length} lines ‚Üí ${lines.length} children`;
      }

      // Get child count based on active tab
      function getChildCount() {
        const activeTab = document.querySelector(".tab-content.active");
        if (activeTab.id === "countTab") {
          // Count tab - use number input
          return parseInt(document.getElementById("childrenCount").value);
        } else {
          // Text tab - count non-empty lines
          const textArea = document.getElementById("childrenText");
          const lines = textArea.value
            .split("\n")
            .filter((line) => line.trim() !== "");
          return lines.length;
        }
      }

      // Get children text array
      function getChildrenTextArray() {
        const activeTab = document.querySelector(".tab-content.active");
        if (activeTab.id === "textTab") {
          const textArea = document.getElementById("childrenText");
          return textArea.value
            .split("\n")
            .filter((line) => line.trim() !== "");
        }
        return []; // Return empty array for count mode
      }

      function showMessage(message, isError = false) {
        // Create a simple toast message at the bottom of the sidebar
        const existingToast = document.getElementById("toast-message");
        if (existingToast) {
          existingToast.remove();
        }

        const toast = document.createElement("div");
        toast.id = "toast-message";
        toast.style.cssText = `
        position: fixed;
        bottom: 16px;
        left: 16px;
        right: 16px;
        background: ${isError ? "#f44336" : "#4caf50"};
        color: white;
        padding: 12px 16px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        text-align: center;
        animation: slideUp 0.3s ease-out;
      `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          if (toast.parentNode) {
            toast.style.animation = "slideDown 0.3s ease-out";
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 300);
          }
        }, 3000);
      }

      // Auto-save gap values to localStorage
      document
        .getElementById("horizontalGap")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_horizontalGap", this.value);
        });

      document
        .getElementById("verticalGap")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_verticalGap", this.value);
        });

      // Auto-save line type to localStorage
      document
        .getElementById("lineType")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_lineType", this.value);
        });

      // Auto-save arrow styles to localStorage
      document
        .getElementById("startArrow")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_startArrow", this.value);
        });

      document
        .getElementById("endArrow")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_endArrow", this.value);
        });

      // Auto-save children text to localStorage
      document
        .getElementById("childrenText")
        .addEventListener("input", function () {
          localStorage.setItem("flowchart_childrenText", this.value);
          updateLineCount();
        });

      // Load saved values
      window.addEventListener("load", function () {
        const savedHorizontalGap = localStorage.getItem(
          "flowchart_horizontalGap",
        );
        if (savedHorizontalGap) {
          document.getElementById("horizontalGap").value = savedHorizontalGap;
        }

        const savedVerticalGap = localStorage.getItem("flowchart_verticalGap");
        if (savedVerticalGap) {
          document.getElementById("verticalGap").value = savedVerticalGap;
        }

        const savedLineType = localStorage.getItem("flowchart_lineType");
        if (savedLineType) {
          document.getElementById("lineType").value = savedLineType;
        }

        const savedStartArrow = localStorage.getItem("flowchart_startArrow");
        if (savedStartArrow) {
          document.getElementById("startArrow").value = savedStartArrow;
        }

        const savedEndArrow = localStorage.getItem("flowchart_endArrow");
        if (savedEndArrow) {
          document.getElementById("endArrow").value = savedEndArrow;
        }

        const savedChildrenText = localStorage.getItem(
          "flowchart_childrenText",
        );
        if (savedChildrenText) {
          document.getElementById("childrenText").value = savedChildrenText;
          updateLineCount();
        }
      });
    </script>
  </body>
</html>
