<!doctype html>
<html>
  <head>
    <base target="_top" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 16px;
        font-size: 14px;
        background-color: #f8f9fa;
      }

      .form-group {
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        justify-content: space-between;
      }

      label {
        font-weight: 500;
        flex: 1;
        margin-right: 10px;
        color: #333;
      }

      input[type="number"] {
        width: 60px;
        padding: 6px 8px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        text-align: center;
        font-size: 14px;
      }

      input[type="number"]:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
      }

      button {
        width: 100%;
        padding: 8px 12px;
        background-color: white;
        color: #24292f;
        border: 1px solid #d1d9e0;
        border-radius: 6px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        margin-bottom: 8px;
        transition: all 0.2s ease;
      }

      button:hover {
        background-color: #f6f8fa;
        border-color: #8c959f;
      }

      button:active {
        background-color: #eaeef2;
        border-color: #8c959f;
      }

      button.secondary {
        background-color: white;
        color: #24292f;
        border: 1px solid #d1d9e0;
      }

      button.secondary:hover {
        background-color: #f6f8fa;
        border-color: #8c959f;
      }

      button.tertiary {
        background-color: white;
        color: #24292f;
        border: 1px solid #d1d9e0;
      }

      button.tertiary:hover {
        background-color: #f6f8fa;
        border-color: #8c959f;
      }

      .input-suffix {
        font-size: 12px;
        color: #666;
        margin-left: 5px;
      }

      .help-text {
        font-size: 12px;
        color: #666;
        margin-top: 4px;
        line-height: 1.4;
      }

      .gap-controls {
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .gap-controls input {
        width: 50px;
      }

      .button-group {
        display: flex;
        gap: 4px;
      }

      .button-group button {
        flex: 1;
        margin-bottom: 0;
      }

      .graph-id-display {
        background-color: #f5f5f5;
        border: 1px solid #e0e0e0;
        border-radius: 4px;
        padding: 12px;
        margin-top: 12px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        line-height: 1.6;
        white-space: pre-wrap;
        word-break: break-all;
        min-height: 60px;
        max-height: 150px;
        overflow-y: auto;
      }

      .graph-id-display.empty {
        color: #999;
        font-style: italic;
        font-family: Arial, sans-serif;
      }

      .tab-container {
        display: flex;
        margin-bottom: 12px;
        border-bottom: 1px solid #e0e0e0;
      }

      .tab-button {
        flex: 1;
        padding: 8px 12px;
        background: none;
        border: none;
        border-bottom: 2px solid transparent;
        border-radius: 0;
        cursor: pointer;
        font-size: 12px;
        font-weight: 500;
        color: #666;
        margin-bottom: 0;
        transition: all 0.2s;
      }

      .tab-button.active {
        color: #1a73e8;
        border-bottom-color: #1a73e8;
        background-color: #f8f9fa;
      }

      .tab-button:hover {
        background-color: #f5f5f5;
      }

      .tab-content {
        display: none;
      }

      .tab-content.active {
        display: block;
      }

      .text-input-area {
        width: calc(100% - 32px);
        min-height: 80px;
        max-height: 120px;
        padding: 8px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 12px;
        font-family: Arial, sans-serif;
        resize: vertical;
        line-height: 1.4;
        margin: 0 auto;
      }

      .text-input-area:focus {
        outline: none;
        border-color: #1a73e8;
        box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
      }

      .line-count-info {
        font-size: 11px;
        color: #666;
        margin-top: 4px;
        text-align: right;
      }

      details {
        background: white;
        border: 1px solid #e1e5e9;
        border-radius: 8px;
        padding: 0;
        margin-bottom: 8px;
        overflow: hidden;
        transition: all 0.2s ease;
      }

      details:hover {
        border-color: #d0d7de;
      }

      details[open] {
        border-color: #1a73e8;
        box-shadow: 0 2px 8px rgba(26, 115, 232, 0.1);
      }

      summary {
        font-weight: 500;
        font-size: 14px;
        color: #24292f;
        padding: 12px 16px;
        cursor: pointer;
        user-select: none;
        list-style: none;
        display: flex;
        align-items: center;
        justify-content: space-between;
        transition: all 0.2s ease;
        border: none;
        background: transparent;
      }

      summary::-webkit-details-marker {
        display: none;
      }

      summary::after {
        content: "";
        width: 16px;
        height: 16px;
        background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23656d76'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E")
          no-repeat center;
        transition: transform 0.2s ease;
        flex-shrink: 0;
      }

      details[open] summary::after {
        transform: rotate(180deg);
      }

      summary:hover {
        background-color: #f6f8fa;
        color: #1a73e8;
      }

      details[open] summary {
        border-bottom: 1px solid #e1e5e9;
        background-color: #f6f8fa;
      }

      .details-content {
        padding: 16px;
        background: white;
      }

      @keyframes slideUp {
        from {
          transform: translateY(100%);
          opacity: 0;
        }
        to {
          transform: translateY(0);
          opacity: 1;
        }
      }

      @keyframes slideDown {
        from {
          transform: translateY(0);
          opacity: 1;
        }
        to {
          transform: translateY(100%);
          opacity: 0;
        }
      }

      .quadrant-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        grid-template-rows: 1fr 1fr;
        gap: 0px;
        width: 80px;
      }

      .quadrant-button {
        background-color: white;
        color: black;
        border: 1px solid #dadce0;
        padding: 2px;
        border-radius: 2px;
        cursor: pointer;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .quadrant-label {
        background-color: #f0f0f0;
        border: 1px solid #ccc;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        color: #666;
        font-size: 12px;
        height: 38px;
      }

      /* Progress bar styles for child creation buttons */
      .button-progress {
        position: relative;
        overflow: hidden;
        pointer-events: none;
        opacity: 0.7;
      }

      .button-progress::before {
        content: "";
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
          90deg,
          transparent,
          rgba(0, 0, 0, 0.1),
          transparent
        );
        animation: buttonProgress 3s ease-in-out;
      }

      .button-progress::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        height: 2px;
        width: 0%;
        background: #24292f;
        animation: buttonProgressBar 3s ease-in-out;
      }

      @keyframes buttonProgress {
        0% {
          left: -100%;
        }
        50% {
          left: 100%;
        }
        100% {
          left: 100%;
        }
      }

      @keyframes buttonProgressBar {
        0% {
          width: 0%;
        }
        100% {
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <details>
      <summary>⚙️ Line Settings</summary>
      <div class="details-content">
        <div class="form-group">
          <label for="lineType">Line Type:</label>
          <select
            id="lineType"
            style="
              width: 120px;
              padding: 6px 8px;
              border: 1px solid #dadce0;
              border-radius: 4px;
              font-size: 14px;
            "
          >
            <option value="STRAIGHT">Straight</option>
            <option value="BENT" selected>Bent/Elbow</option>
            <option value="CURVED">Curved</option>
          </select>
        </div>

        <div class="form-group">
          <label for="startArrow">Start Arrow:</label>
          <select
            id="startArrow"
            style="
              width: 120px;
              padding: 6px 8px;
              border: 1px solid #dadce0;
              border-radius: 4px;
              font-size: 14px;
            "
          >
            <option value="NONE" selected>None</option>
            <option value="FILL_ARROW">Fill Arrow</option>
            <option value="STEALTH_ARROW">Stealth Arrow</option>
            <option value="OPEN_ARROW">Open Arrow</option>
            <option value="FILL_CIRCLE">Fill Circle</option>
            <option value="OPEN_CIRCLE">Open Circle</option>
            <option value="FILL_SQUARE">Fill Square</option>
            <option value="OPEN_SQUARE">Open Square</option>
            <option value="FILL_DIAMOND">Fill Diamond</option>
            <option value="OPEN_DIAMOND">Open Diamond</option>
          </select>
        </div>

        <div class="form-group">
          <label for="endArrow">End Arrow:</label>
          <select
            id="endArrow"
            style="
              width: 120px;
              padding: 6px 8px;
              border: 1px solid #dadce0;
              border-radius: 4px;
              font-size: 14px;
            "
          >
            <option value="NONE">None</option>
            <option value="FILL_ARROW" selected>Fill Arrow</option>
            <option value="STEALTH_ARROW">Stealth Arrow</option>
            <option value="OPEN_ARROW">Open Arrow</option>
            <option value="FILL_CIRCLE">Fill Circle</option>
            <option value="OPEN_CIRCLE">Open Circle</option>
            <option value="FILL_SQUARE">Fill Square</option>
            <option value="OPEN_SQUARE">Open Square</option>
            <option value="FILL_DIAMOND">Fill Diamond</option>
            <option value="OPEN_DIAMOND">Open Diamond</option>
          </select>
        </div>
      </div>
    </details>

    <details>
      <summary>🔗 Connect Shapes</summary>
      <div class="details-content">
        <div class="button-group">
          <button onclick="connectShapesVertical()">
            ⬆⬇ Connect Top/Down
          </button>
          <button onclick="connectShapesHorizontal()">
            ⬅➡ Connect Left/Right
          </button>
        </div>

        <br />
        <div style="font-size: 12px; color: #666; margin-bottom: 8px">
          Quadrant-based connections:
        </div>

        <div style="display: flex; gap: 18px; justify-content: center">
          <!-- 左側 2x2 表格 -->
          <div class="quadrant-grid">
            <button onclick="connectLLQRUQ_TopLeft()" class="quadrant-button">
              <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
                <path
                  d="M18 27 L18 18 L27 18"
                  stroke="black"
                  stroke-width="2"
                  fill="none"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <div class="quadrant-label">B</div>
            <div class="quadrant-label">A</div>
            <button
              onclick="connectLLQRUQ_RightBottom()"
              class="quadrant-button"
            >
              <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
                <path
                  d="M9 18 L18 18 L18 9"
                  stroke="black"
                  stroke-width="2"
                  fill="none"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
          </div>

          <!-- 右側 2x2 表格 -->
          <div class="quadrant-grid">
            <div class="quadrant-label">A</div>
            <button onclick="connectLUQRLQ_RightTop()" class="quadrant-button">
              <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
                <path
                  d="M9 18 L18 18 L18 27"
                  stroke="black"
                  stroke-width="2"
                  fill="none"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <button
              onclick="connectLUQRLQ_BottomLeft()"
              class="quadrant-button"
            >
              <svg width="36" height="36" viewBox="0 0 36 36" fill="none">
                <path
                  d="M18 9 L18 18 L27 18"
                  stroke="black"
                  stroke-width="2"
                  fill="none"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                />
              </svg>
            </button>
            <div class="quadrant-label">B</div>
          </div>
        </div>
      </div>
    </details>

    <details>
      <summary>➕ Create Child Shapes</summary>
      <div class="details-content">
        <div class="tab-container">
          <button class="tab-button active" onclick="switchTab('count')">
            📊 By Count
          </button>
          <button class="tab-button" onclick="switchTab('text')">
            📝 By Text
          </button>
        </div>

        <!-- Count Tab -->
        <div id="countTab" class="tab-content active">
          <div class="form-group">
            <label for="childrenCount">Children Count:</label>
            <div class="gap-controls">
              <input
                type="number"
                id="childrenCount"
                min="1"
                max="10"
                value="1"
              />
              <span class="input-suffix">shapes</span>
            </div>
          </div>
        </div>

        <!-- Text Tab -->
        <div id="textTab" class="tab-content">
          <div
            class="form-group"
            style="flex-direction: column; align-items: stretch"
          >
            <label for="childrenText" style="margin-bottom: 6px"
              >Children Text (one per line):</label
            >
            <textarea
              id="childrenText"
              class="text-input-area"
              placeholder="Enter text for each child shape...&#10;Line 1 = Child 1&#10;Line 2 = Child 2&#10;Line 3 = Child 3"
              oninput="updateLineCount()"
            ></textarea>
            <div id="lineCount" class="line-count-info">
              0 lines → 0 children
            </div>
          </div>
        </div>

        <div class="form-group">
          <label for="horizontalGap">Horizontal Gap:</label>
          <div class="gap-controls">
            <input type="number" id="horizontalGap" min="0" value="20" />
            <span class="input-suffix">pt</span>
          </div>
        </div>

        <div class="form-group">
          <label for="verticalGap">Vertical Gap:</label>
          <div class="gap-controls">
            <input type="number" id="verticalGap" min="0" value="20" />
            <span class="input-suffix">pt</span>
          </div>
        </div>

        <br />

        <div class="button-group">
          <button class="secondary" onclick="createChildTop()">
            ⬆ Create Top
          </button>
          <button class="tertiary" onclick="createChildRight()">
            ➡ Create Right
          </button>
        </div>
        <div class="button-group" style="margin-top: 8px">
          <button class="secondary" onclick="createChildBottom()">
            ⬇ Create Bottom
          </button>
          <button class="tertiary" onclick="createChildLeft()">
            ⬅ Create Left
          </button>
        </div>

        <br />
        <button onclick="createSibling()">👥 Create Sibling</button>
      </div>
    </details>

    <details>
      <summary>🎨 Add BG for selected elements</summary>
      <div class="details-content">
        <div class="form-group">
          <label for="bgPadding">Padding:</label>
          <div class="gap-controls">
            <input type="number" id="bgPadding" min="0" value="10" />
            <span class="input-suffix">pt</span>
          </div>
        </div>

        <div class="form-group">
          <label for="bgColor">Background Color:</label>
          <input
            type="color"
            id="bgColor"
            value="#f3f3f3"
            style="
              width: 60px;
              height: 30px;
              padding: 0;
              border: 1px solid #dadce0;
              border-radius: 4px;
              cursor: pointer;
            "
          />
        </div>

        <div class="form-group">
          <label for="bgOpacity">Opacity:</label>
          <div class="gap-controls">
            <input
              type="range"
              id="bgOpacity"
              min="0"
              max="100"
              value="50"
              style="width: 100px; margin-right: 8px"
            />
            <span id="opacityValue" class="input-suffix">50%</span>
          </div>
        </div>

        <button onclick="addBackgroundToSelection()">
          🎨 Add Background Rectangle
        </button>
        <div class="help-text">
          Select multiple shapes, then click to create a background rectangle
          that encompasses all selected elements with padding.
        </div>
      </div>
    </details>

    <details>
      <summary>📊 Add Stage Bar</summary>
      <div class="details-content">
        <div class="form-group">
          <label for="stageY">Y Position:</label>
          <div class="gap-controls">
            <input type="number" id="stageY" min="0" value="100" />
            <span class="input-suffix">pt</span>
          </div>
        </div>

        <div class="form-group">
          <label for="stageOffsetX">X Offset:</label>
          <div class="gap-controls">
            <input type="number" id="stageOffsetX" value="-20" />
            <span class="input-suffix">pt</span>
          </div>
        </div>

        <div class="form-group">
          <label for="stageExtraWidth">Extra Width:</label>
          <div class="gap-controls">
            <input type="number" id="stageExtraWidth" min="0" value="30" />
            <span class="input-suffix">pt</span>
          </div>
        </div>

        <div class="form-group">
          <label for="stageHeight">Height:</label>
          <div class="gap-controls">
            <input type="number" id="stageHeight" min="5" value="15" />
            <span class="input-suffix">pt</span>
          </div>
        </div>

        <div class="form-group">
          <label for="stageColor">Stage Color:</label>
          <input
            type="color"
            id="stageColor"
            value="#3D6869"
            style="
              width: 60px;
              height: 30px;
              padding: 0;
              border: 1px solid #dadce0;
              border-radius: 4px;
              cursor: pointer;
            "
          />
        </div>

        <div class="form-group">
          <label for="stageOpacity">Opacity:</label>
          <div class="gap-controls">
            <input
              type="range"
              id="stageOpacity"
              min="0"
              max="100"
              value="100"
              style="width: 100px; margin-right: 8px"
            />
            <span id="stageOpacityValue" class="input-suffix">100%</span>
          </div>
        </div>

        <div class="form-group">
          <label for="stageText">Text (optional):</label>
          <input
            type="text"
            id="stageText"
            placeholder="Enter text..."
            style="
              width: 120px;
              padding: 6px 8px;
              border: 1px solid #dadce0;
              border-radius: 4px;
              font-size: 14px;
            "
          />
        </div>

        <button onclick="addStageBarToSelection()">📊 Add Stage Bar</button>
        <div class="help-text">
          Select shapes, then click to create a HOME_PLATE stage bar above them.
        </div>
      </div>
    </details>

    <details>
      <summary>🔧 Graph ID Inspector</summary>
      <div class="details-content">
        <div class="button-group">
          <button onclick="showGraphId()">👁️ Refresh</button>
          <button onclick="clearGraphId()">🗑️ Clear</button>
        </div>
        <div id="graphIdDisplay" class="graph-id-display empty">
          Select a shape and click Refresh to view its Graph ID
        </div>
      </div>
    </details>

    <script>
      function connectShapesVertical() {
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        // Get the button and start progress animation
        const button = event.target;
        const originalText = "⬆⬇ Connect Top/Down";
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            showMessage("Shapes connected vertically!");
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .connectSelectedShapesVertical(lineType, startArrow, endArrow);
      }

      function connectShapesHorizontal() {
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        // Get the button and start progress animation
        const button = event.target;
        const originalText = "⬅➡ Connect Left/Right";
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            showMessage("Shapes connected horizontally!");
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .connectSelectedShapesHorizontal(lineType, startArrow, endArrow);
      }

      // 四象限連接函數
      function connectLLQRUQ_TopLeft() {
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        // Get the button and start progress animation
        const button = event.target;
        const originalText = button.innerHTML; // Preserve SVG content
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            showMessage("Shapes connected (LLQ→RUQ Top→Left)!");
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .connectLLQRUQ_TopLeft(lineType, startArrow, endArrow);
      }

      function connectLLQRUQ_RightBottom() {
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        // Get the button and start progress animation
        const button = event.target;
        const originalText = button.innerHTML; // Preserve SVG content
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            showMessage("Shapes connected (LLQ→RUQ Right→Bottom)!");
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .connectLLQRUQ_RightBottom(lineType, startArrow, endArrow);
      }

      function connectLUQRLQ_RightTop() {
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        // Get the button and start progress animation
        const button = event.target;
        const originalText = button.innerHTML; // Preserve SVG content
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            showMessage("Shapes connected (LUQ→RLQ Right→Top)!");
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .connectLUQRLQ_RightTop(lineType, startArrow, endArrow);
      }

      function connectLUQRLQ_BottomLeft() {
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        // Get the button and start progress animation
        const button = event.target;
        const originalText = button.innerHTML; // Preserve SVG content
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            showMessage("Shapes connected (LUQ→RLQ Bottom→Left)!");
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .connectLUQRLQ_BottomLeft(lineType, startArrow, endArrow);
      }

      function createChildTop() {
        const verticalGap = parseInt(
          document.getElementById("verticalGap").value,
        );
        const childrenCount = getChildCount();
        const childrenTexts = getChildrenTextArray();
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        if (verticalGap < 0 || isNaN(verticalGap)) {
          showMessage(
            "Please enter a valid vertical gap value (0 or greater)",
            true,
          );
          return;
        }

        if (childrenCount < 1 || childrenCount > 10 || isNaN(childrenCount)) {
          showMessage("Please enter a valid children count (1-10)", true);
          return;
        }

        // Get the button and start progress animation
        const button = event.target;
        const originalText = "⬆ Create Top";
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            const msg =
              childrenCount === 1
                ? "Child shape created above successfully!"
                : `${childrenCount} child shapes created above successfully!`;
            showMessage(msg);
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .createChildTopWithText(
            verticalGap,
            lineType,
            childrenCount,
            startArrow,
            endArrow,
            childrenTexts,
          );
      }

      function createChildRight() {
        const horizontalGap = parseInt(
          document.getElementById("horizontalGap").value,
        );
        const childrenCount = getChildCount();
        const childrenTexts = getChildrenTextArray();
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        if (horizontalGap < 0 || isNaN(horizontalGap)) {
          showMessage(
            "Please enter a valid horizontal gap value (0 or greater)",
            true,
          );
          return;
        }

        if (childrenCount < 1 || childrenCount > 10 || isNaN(childrenCount)) {
          showMessage("Please enter a valid children count (1-10)", true);
          return;
        }

        // Get the button and start progress animation
        const button = event.target;
        const originalText = "➡ Create Right";
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            const msg =
              childrenCount === 1
                ? "Child shape created to the right successfully!"
                : `${childrenCount} child shapes created to the right successfully!`;
            showMessage(msg);
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .createChildRightWithText(
            horizontalGap,
            lineType,
            childrenCount,
            startArrow,
            endArrow,
            childrenTexts,
          );
      }

      function createChildBottom() {
        const verticalGap = parseInt(
          document.getElementById("verticalGap").value,
        );
        const childrenCount = getChildCount();
        const childrenTexts = getChildrenTextArray();
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        if (verticalGap < 0 || isNaN(verticalGap)) {
          showMessage(
            "Please enter a valid vertical gap value (0 or greater)",
            true,
          );
          return;
        }

        if (childrenCount < 1 || childrenCount > 10 || isNaN(childrenCount)) {
          showMessage("Please enter a valid children count (1-10)", true);
          return;
        }

        // Get the button and start progress animation
        const button = event.target;
        const originalText = "⬇ Create Bottom";
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            const msg =
              childrenCount === 1
                ? "Child shape created below successfully!"
                : `${childrenCount} child shapes created below successfully!`;
            showMessage(msg);
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .createChildBottomWithText(
            verticalGap,
            lineType,
            childrenCount,
            startArrow,
            endArrow,
            childrenTexts,
          );
      }

      function createChildLeft() {
        const horizontalGap = parseInt(
          document.getElementById("horizontalGap").value,
        );
        const childrenCount = getChildCount();
        const childrenTexts = getChildrenTextArray();
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        if (horizontalGap < 0 || isNaN(horizontalGap)) {
          showMessage(
            "Please enter a valid horizontal gap value (0 or greater)",
            true,
          );
          return;
        }

        if (childrenCount < 1 || childrenCount > 10 || isNaN(childrenCount)) {
          showMessage("Please enter a valid children count (1-10)", true);
          return;
        }

        // Get the button and start progress animation
        const button = event.target;
        const originalText = "⬅ Create Left";
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            const msg =
              childrenCount === 1
                ? "Child shape created to the left successfully!"
                : `${childrenCount} child shapes created to the left successfully!`;
            showMessage(msg);
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .createChildLeftWithText(
            horizontalGap,
            lineType,
            childrenCount,
            startArrow,
            endArrow,
            childrenTexts,
          );
      }

      function createSibling() {
        const horizontalGap = parseInt(
          document.getElementById("horizontalGap").value,
        );
        const verticalGap = parseInt(
          document.getElementById("verticalGap").value,
        );
        const lineType = document.getElementById("lineType").value;
        const startArrow = document.getElementById("startArrow").value;
        const endArrow = document.getElementById("endArrow").value;

        if (horizontalGap < 0 || isNaN(horizontalGap)) {
          showMessage(
            "Please enter a valid horizontal gap value (0 or greater)",
            true,
          );
          return;
        }

        if (verticalGap < 0 || isNaN(verticalGap)) {
          showMessage(
            "Please enter a valid vertical gap value (0 or greater)",
            true,
          );
          return;
        }

        // Get the button and start progress animation
        const button = event.target;
        const originalText = "👥 Create Sibling";
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            showMessage("Sibling shape created successfully!");
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .createSiblingShape(
            horizontalGap,
            verticalGap,
            lineType,
            startArrow,
            endArrow,
          );
      }

      function showGraphId() {
        // Get the button and start progress animation
        const button = event.target;
        const originalText = "👁️ Refresh";
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function (result) {
            endButtonProgress(button, originalText);
            const display = document.getElementById("graphIdDisplay");
            if (
              result.includes("No Graph ID") ||
              result.includes("Please select")
            ) {
              display.className = "graph-id-display empty";
              display.textContent = result;
            } else {
              display.className = "graph-id-display";
              display.textContent = result;
            }
            // Also show a brief success message
            if (
              !result.includes("Error") &&
              !result.includes("Please select")
            ) {
              showMessage("Graph ID refreshed!");
            }
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            const display = document.getElementById("graphIdDisplay");
            display.className = "graph-id-display empty";
            display.textContent = "Error: " + error;
            showMessage("Error: " + error, true);
          })
          .showSelectedShapeGraphId();
      }

      function clearGraphId() {
        const clearButton = document.querySelector(
          'button[onclick="clearGraphId()"]',
        );

        // Check if button is already in confirmation state
        if (clearButton.textContent.trim() === "Sure?") {
          // User clicked "Sure?" - proceed with clearing
          clearButton.textContent = "🗑️ Clear";
          clearButton.style.backgroundColor = "#f44336";

          google.script.run
            .withSuccessHandler(function (result) {
              showMessage(result);
              // Update the display
              const display = document.getElementById("graphIdDisplay");
              display.className = "graph-id-display empty";
              if (result.includes("successfully")) {
                display.textContent =
                  "Graph ID cleared. Select another shape and click Refresh.";
              } else {
                display.textContent = result;
              }
            })
            .withFailureHandler(function (error) {
              showMessage("Error: " + error, true);
            })
            .clearSelectedShapeGraphId();
        } else {
          // First click - show confirmation state
          clearButton.textContent = "Sure?";
          clearButton.style.backgroundColor = "#ff9800";

          // Set timeout to revert after 5 seconds
          setTimeout(function () {
            if (clearButton.textContent.trim() === "Sure?") {
              clearButton.textContent = "🗑️ Clear";
              clearButton.style.backgroundColor = "#f44336";
            }
          }, 5000);
        }
      }

      // Tab switching functionality
      function switchTab(tabName) {
        // Remove active class from all tab buttons
        document.querySelectorAll(".tab-button").forEach((btn) => {
          btn.classList.remove("active");
        });

        // Remove active class from all tab content
        document.querySelectorAll(".tab-content").forEach((content) => {
          content.classList.remove("active");
        });

        // Add active class to clicked tab button
        event.target.classList.add("active");

        // Show corresponding tab content
        if (tabName === "count") {
          document.getElementById("countTab").classList.add("active");
        } else if (tabName === "text") {
          document.getElementById("textTab").classList.add("active");
        }
      }

      // Update line count for text input
      function updateLineCount() {
        const textArea = document.getElementById("childrenText");
        const lines = textArea.value
          .split("\n")
          .filter((line) => line.trim() !== "");
        const lineCountDisplay = document.getElementById("lineCount");
        lineCountDisplay.textContent = `${lines.length} lines → ${lines.length} children`;
      }

      // Get child count based on active tab
      function getChildCount() {
        const activeTab = document.querySelector(".tab-content.active");
        if (activeTab.id === "countTab") {
          // Count tab - use number input
          return parseInt(document.getElementById("childrenCount").value);
        } else {
          // Text tab - count non-empty lines
          const textArea = document.getElementById("childrenText");
          const lines = textArea.value
            .split("\n")
            .filter((line) => line.trim() !== "");
          return lines.length;
        }
      }

      // Get children text array
      function getChildrenTextArray() {
        const activeTab = document.querySelector(".tab-content.active");
        if (activeTab.id === "textTab") {
          const textArea = document.getElementById("childrenText");
          return textArea.value
            .split("\n")
            .filter((line) => line.trim() !== "");
        }
        return []; // Return empty array for count mode
      }

      function addBackgroundToSelection() {
        const padding = parseInt(document.getElementById("bgPadding").value);
        const bgColor = document.getElementById("bgColor").value;
        const opacity =
          parseInt(document.getElementById("bgOpacity").value) / 100;

        if (padding < 0 || isNaN(padding)) {
          showMessage(
            "Please enter a valid padding value (0 or greater)",
            true,
          );
          return;
        }

        if (opacity < 0 || opacity > 1 || isNaN(opacity)) {
          showMessage("Please enter a valid opacity value (0-100%)", true);
          return;
        }

        // Get the button and start progress animation
        const button = event.target;
        const originalText = "🎨 Add Background Rectangle";
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            showMessage("Background rectangle added successfully!");
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .addBackgroundToSelectedElements(padding, bgColor, opacity);
      }

      function updateOpacityDisplay() {
        const opacitySlider = document.getElementById("bgOpacity");
        const opacityValue = document.getElementById("opacityValue");
        opacityValue.textContent = opacitySlider.value + "%";
      }

      function updateStageOpacityDisplay() {
        const opacitySlider = document.getElementById("stageOpacity");
        const opacityValue = document.getElementById("stageOpacityValue");
        opacityValue.textContent = opacitySlider.value + "%";
      }

      function addStageBarToSelection() {
        const baseY = parseInt(document.getElementById("stageY").value);
        const offsetX = parseInt(document.getElementById("stageOffsetX").value);
        const extraWidth = parseInt(
          document.getElementById("stageExtraWidth").value,
        );
        const height = parseInt(document.getElementById("stageHeight").value);
        const fillColor = document.getElementById("stageColor").value;
        const opacity =
          parseInt(document.getElementById("stageOpacity").value) / 100;
        const strokeColor = "#FFFFFF"; // Default white stroke
        const text = document.getElementById("stageText").value;
        const fontSize = 10; // Default font size

        if (baseY < 0 || isNaN(baseY)) {
          showMessage("Please enter a valid Y position (0 or greater)", true);
          return;
        }

        if (isNaN(offsetX)) {
          showMessage("Please enter a valid X offset value", true);
          return;
        }

        if (extraWidth < 0 || isNaN(extraWidth)) {
          showMessage("Please enter a valid extra width (0 or greater)", true);
          return;
        }

        if (height < 5 || isNaN(height)) {
          showMessage("Please enter a valid height (5 or greater)", true);
          return;
        }

        if (opacity < 0 || opacity > 1 || isNaN(opacity)) {
          showMessage("Please enter a valid opacity value (0-100%)", true);
          return;
        }

        // Get the button and start progress animation
        const button = event.target;
        const originalText = "📊 Add Stage Bar";
        startButtonProgress(button, originalText);

        google.script.run
          .withSuccessHandler(function () {
            endButtonProgress(button, originalText);
            showMessage("Stage bar added successfully!");
          })
          .withFailureHandler(function (error) {
            endButtonProgress(button, originalText);
            showMessage("Error: " + error, true);
          })
          .addStageBar(
            baseY,
            offsetX,
            extraWidth,
            height,
            fillColor,
            opacity,
            strokeColor,
            text,
            fontSize,
          );
      }

      function showMessage(message, isError = false) {
        // Create a simple toast message at the bottom of the sidebar
        const existingToast = document.getElementById("toast-message");
        if (existingToast) {
          existingToast.remove();
        }

        const toast = document.createElement("div");
        toast.id = "toast-message";
        toast.style.cssText = `
        position: fixed;
        bottom: 16px;
        left: 16px;
        right: 16px;
        background: ${isError ? "#f44336" : "#4caf50"};
        color: white;
        padding: 12px 16px;
        border-radius: 4px;
        font-size: 14px;
        z-index: 1000;
        box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        text-align: center;
        animation: slideUp 0.3s ease-out;
      `;
        toast.textContent = message;
        document.body.appendChild(toast);

        setTimeout(() => {
          if (toast.parentNode) {
            toast.style.animation = "slideDown 0.3s ease-out";
            setTimeout(() => {
              if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
              }
            }, 300);
          }
        }, 3000);
      }

      // Auto-save gap values to localStorage
      document
        .getElementById("horizontalGap")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_horizontalGap", this.value);
        });

      document
        .getElementById("verticalGap")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_verticalGap", this.value);
        });

      // Auto-save line type to localStorage
      document
        .getElementById("lineType")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_lineType", this.value);
        });

      // Auto-save arrow styles to localStorage
      document
        .getElementById("startArrow")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_startArrow", this.value);
        });

      document
        .getElementById("endArrow")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_endArrow", this.value);
        });

      // Auto-save children text to localStorage
      document
        .getElementById("childrenText")
        .addEventListener("input", function () {
          localStorage.setItem("flowchart_childrenText", this.value);
          updateLineCount();
        });

      // Auto-save background settings to localStorage and update opacity display
      document
        .getElementById("bgPadding")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_bgPadding", this.value);
        });

      document
        .getElementById("bgColor")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_bgColor", this.value);
        });

      document
        .getElementById("bgOpacity")
        .addEventListener("input", function () {
          updateOpacityDisplay();
          localStorage.setItem("flowchart_bgOpacity", this.value);
        });

      // Auto-save stage bar settings to localStorage
      document.getElementById("stageY").addEventListener("change", function () {
        localStorage.setItem("flowchart_stageY", this.value);
      });

      document
        .getElementById("stageOffsetX")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_stageOffsetX", this.value);
        });

      document
        .getElementById("stageExtraWidth")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_stageExtraWidth", this.value);
        });

      document
        .getElementById("stageHeight")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_stageHeight", this.value);
        });

      document
        .getElementById("stageColor")
        .addEventListener("change", function () {
          localStorage.setItem("flowchart_stageColor", this.value);
        });

      document
        .getElementById("stageOpacity")
        .addEventListener("input", function () {
          updateStageOpacityDisplay();
          localStorage.setItem("flowchart_stageOpacity", this.value);
        });

      document
        .getElementById("stageText")
        .addEventListener("input", function () {
          localStorage.setItem("flowchart_stageText", this.value);
        });

      // Button progress animation helpers
      function startButtonProgress(button, originalText) {
        button.classList.add("button-progress");
        // Check if originalText contains HTML (SVG icons)
        if (originalText.includes("<")) {
          button.innerHTML = "...";
        } else {
          button.textContent = "Creating...";
        }
        button.disabled = true;
      }

      function endButtonProgress(button, originalText) {
        button.classList.remove("button-progress");
        // Check if originalText contains HTML (SVG icons)
        if (originalText.includes("<")) {
          button.innerHTML = originalText;
        } else {
          button.textContent = originalText;
        }
        button.disabled = false;
      }

      // Mutually exclusive accordion behavior
      function setupMutuallyExclusiveAccordions() {
        const detailsElements = document.querySelectorAll("details");

        detailsElements.forEach((targetDetail) => {
          targetDetail.addEventListener("toggle", function () {
            if (this.open) {
              // Close all other details when this one opens
              detailsElements.forEach((otherDetail) => {
                if (otherDetail !== this && otherDetail.open) {
                  otherDetail.open = false;
                }
              });
            }
          });
        });
      }

      // Load saved values
      window.addEventListener("load", function () {
        const savedHorizontalGap = localStorage.getItem(
          "flowchart_horizontalGap",
        );
        if (savedHorizontalGap) {
          document.getElementById("horizontalGap").value = savedHorizontalGap;
        }

        const savedVerticalGap = localStorage.getItem("flowchart_verticalGap");
        if (savedVerticalGap) {
          document.getElementById("verticalGap").value = savedVerticalGap;
        }

        const savedLineType = localStorage.getItem("flowchart_lineType");
        if (savedLineType) {
          document.getElementById("lineType").value = savedLineType;
        }

        const savedStartArrow = localStorage.getItem("flowchart_startArrow");
        if (savedStartArrow) {
          document.getElementById("startArrow").value = savedStartArrow;
        }

        const savedEndArrow = localStorage.getItem("flowchart_endArrow");
        if (savedEndArrow) {
          document.getElementById("endArrow").value = savedEndArrow;
        }

        const savedChildrenText = localStorage.getItem(
          "flowchart_childrenText",
        );
        if (savedChildrenText) {
          document.getElementById("childrenText").value = savedChildrenText;
          updateLineCount();
        }

        // Load background settings
        const savedBgPadding = localStorage.getItem("flowchart_bgPadding");
        if (savedBgPadding) {
          document.getElementById("bgPadding").value = savedBgPadding;
        }

        const savedBgColor = localStorage.getItem("flowchart_bgColor");
        if (savedBgColor) {
          document.getElementById("bgColor").value = savedBgColor;
        }

        const savedBgOpacity = localStorage.getItem("flowchart_bgOpacity");
        if (savedBgOpacity) {
          document.getElementById("bgOpacity").value = savedBgOpacity;
          updateOpacityDisplay();
        } else {
          updateOpacityDisplay(); // Initialize display even if no saved value
        }

        // Load stage bar settings
        const savedStageY = localStorage.getItem("flowchart_stageY");
        if (savedStageY) {
          document.getElementById("stageY").value = savedStageY;
        }

        const savedStageOffsetX = localStorage.getItem(
          "flowchart_stageOffsetX",
        );
        if (savedStageOffsetX) {
          document.getElementById("stageOffsetX").value = savedStageOffsetX;
        }

        const savedStageExtraWidth = localStorage.getItem(
          "flowchart_stageExtraWidth",
        );
        if (savedStageExtraWidth) {
          document.getElementById("stageExtraWidth").value =
            savedStageExtraWidth;
        }

        const savedStageHeight = localStorage.getItem("flowchart_stageHeight");
        if (savedStageHeight) {
          document.getElementById("stageHeight").value = savedStageHeight;
        }

        const savedStageColor = localStorage.getItem("flowchart_stageColor");
        if (savedStageColor) {
          document.getElementById("stageColor").value = savedStageColor;
        }

        const savedStageOpacity = localStorage.getItem(
          "flowchart_stageOpacity",
        );
        if (savedStageOpacity) {
          document.getElementById("stageOpacity").value = savedStageOpacity;
          updateStageOpacityDisplay();
        } else {
          updateStageOpacityDisplay(); // Initialize display even if no saved value
        }

        const savedStageText = localStorage.getItem("flowchart_stageText");
        if (savedStageText) {
          document.getElementById("stageText").value = savedStageText;
        }

        // Setup mutually exclusive accordion behavior
        setupMutuallyExclusiveAccordions();
      });
    </script>
  </body>
</html>
